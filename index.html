<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Loterias</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #00e676;
            --accent-hover: #00c853;
            --danger: #ff5252;
            --virada: #ffab00;
            /* Gold for Mega da Virada */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1,
        h2,
        h3 {
            margin-top: 0;
        }

        /* Layout */
        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 350px 1fr;
            }
        }

        /* Panels */
        .panel {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        select,
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s;
            font-size: 16px;
            width: 100%;
        }

        .btn-primary {
            background-color: var(--accent);
            color: #000;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        /* Number Grid Selection */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .grid-num {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .grid-num.selected {
            background-color: var(--accent);
            color: #000;
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Registered Tickets List */
        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ticket-card {
            background-color: #252525;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #444;
            transition: transform 0.3s ease, border-color 0.3s;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ticket-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .ticket-game-type {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ticket-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ticket-num {
            background-color: #333;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .ticket-num.hit {
            background-color: var(--accent);
            color: #000;
            box-shadow: 0 0 10px var(--accent);
            transform: scale(1.2);
            font-weight: bold;
            border: 2px solid white;
        }

        .match-count {
            background: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .match-count.winner {
            background-color: var(--virada);
            color: #000;
            font-weight: bold;
        }

        /* Draw Area */
        .draw-area {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        .drawn-numbers-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .drawn-num {
            width: 45px;
            height: 45px;
            background-color: var(--accent);
            color: #000;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }

            80% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transform: translateY(100px);
            transition: transform 0.3s;
            z-index: 2500;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.error {
            background-color: var(--danger);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            border: 1px solid #444;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        /* ... existing styles ... */

        /* Winner Styles */
        .ticket-card.win-max {
            border: 2px solid #ffd700;
            /* Gold */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            background: linear-gradient(145deg, #2a2a2a 0%, #3e3820 100%);
        }

        .ticket-card.win-high {
            border: 2px solid #c0c0c0;
            /* Silver */
            box-shadow: 0 0 10px rgba(192, 192, 192, 0.3);
        }

        .ticket-card.win-mid {
            border: 2px solid #cd7f32;
            /* Bronze */
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
            color: #000;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .badge-max {
            background-color: #ffd700;
            box-shadow: 0 0 10px #ffd700;
        }

        .badge-high {
            background-color: #c0c0c0;
        }

        .badge-mid {
            background-color: #cd7f32;
            color: white;
        }

        .badge-low {
            background-color: #444;
            color: white;
            border: 1px solid #666;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Neon Effect for drawing input */
        #drawInput:focus {
            box-shadow: 0 0 15px var(--accent);
            border-color: var(--accent);
            outline: none;
        }

        /* Improved Hit Style */
        .ticket-num.hit {
            background-color: var(--accent);
            color: #000;
            box-shadow: 0 0 15px var(--accent);
            transform: scale(1.15);
            font-weight: 800;
            border: 2px solid #fff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>

    <div id="toast" class="toast"></div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">Confirma√ß√£o</h3>
            <p id="modalMessage">Tem certeza?</p>
            <div class="modal-actions">
                <button class="btn-primary" id="btnConfirm" style="width: auto;">Sim</button>
                <button class="btn-danger" id="btnCancel" style="width: auto; background-color: #555;">Cancelar</button>
            </div>
        </div>
    </div>

    <header style="text-align: center; margin-bottom: 30px;">
        <h1>üé∞ Gerenciador de Loterias</h1>
        <p style="color: var(--text-secondary);">Cadastre seus volantes e confira o sorteio em tempo real</p>
    </header>

    <div class="container">
        <!-- Sidebar / Registration & Controls -->
        <aside class="panel">
            <h2>Novo Jogo</h2>

            <div class="form-group">
                <label>Modalidade</label>
                <select id="gameType" onchange="updateFormRules()">
                    <option value="megasena">Mega-Sena</option>
                    <option value="lotofacil">Lotof√°cil</option>
                    <option value="quina">Quina</option>
                    <option value="lotomania">Lotomania</option>
                    <option value="timemania">Timemania</option>
                    <option value="diadesorte">Dia de Sorte</option>
                </select>
            </div>

            <div class="form-group">
                <label>Identifica√ß√£o (Opccional)</label>
                <input type="text" id="ticketName" placeholder="Ex: Bol√£o da Firma">
            </div>

            <div class="form-group">
                <label>Quantidade de Dezenas</label>
                <select id="numberQuantity" onchange="renderGrid()">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="form-group">
                <label>Selecione os N√∫meros: <span id="selectionCount">0</span></label>
                <div id="gridSelection" class="number-grid">
                    <!-- Grid generated by JS -->
                </div>
            </div>

            <button class="btn-primary" onclick="addTicket()">Salvar Bilhete</button>
            <br><br>

            <div
                style="background: #252525; padding: 10px; border-radius: 6px; border: 1px dashed #555; margin-bottom: 20px;">
                <label style="font-size: 0.9em; cursor: pointer;">üìÑ Importar PDF (Simples)</label>
                <input type="file" id="pdfUpload" accept="application/pdf" onchange="handlePdfUpload(event)"
                    style="font-size: 0.8em; margin-top: 5px;">
                <div id="pdfStatus" style="font-size: 0.8em; color: var(--accent); margin-top: 5px;"></div>

                <hr style="border-color: #444; margin: 10px 0;">

                <button class="btn-primary" style="background-color: #444; font-size: 0.9em;"
                    onclick="openImportModal()">
                    üì• Importa√ß√£o Avan√ßada (CSV)
                </button>
            </div>

            <div style="border-top: 1px solid #444; padding-top: 20px;">
                <button class="btn-danger" style="width:100%" onclick="clearAllData()">Limpar Tudo (Reset)</button>
            </div>
        </aside>

        <!-- Main Content / Tickets & Draw -->
        <main class="panel">
            <div class="draw-area">
                <h2>Confer√™ncia (Sorteio)</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="drawInput" placeholder="N¬∫ Sorteado" style="max-width: 150px;">
                    <button class="btn-primary" style="width: auto;" onclick="addDrawnNumber()">Adicionar</button>
                    <button class="btn-danger" style="width: auto; background-color: #444;"
                        onclick="resetDraw()">Reiniciar Sorteio</button>
                </div>
                <div id="drawnNumbersList" class="drawn-numbers-display">
                    <!-- Drawn numbers appear here -->
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Bilhetes Cadastrados (<span id="totalTickets">0</span>)</h3>
                <div>
                    Filtro: <select id="filterType" onchange="renderTickets()" style="width: auto; padding: 5px;">
                        <option value="all">Todas</option>
                        <option value="megasena">Mega-Sena</option>
                        <option value="lotofacil">Lotof√°cil</option>
                        <option value="quina">Quina</option>
                        <option value="lotomania">Lotomania</option>
                        <option value="timemania">Timemania</option>
                        <option value="diadesorte">Dia de Sorte</option>
                    </select>
                </div>
            </div>

            <div id="ticketsContainer" class="tickets-list">
                <!-- Tickets will be rendered here -->
                <p style="text-align: center; color: #555; margin-top: 50px;">Nenhum bilhete cadastrado.</p>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Prize Levels: 'max' (confetti + gold), 'high' (silver/virada), 'mid' (bronze/simple)
        const GAMES = {
            megasena: {
                name: "Mega-Sena", min: 6, max: 20, range: 60, start: 1, color: "#209869",
                prizes: {
                    6: { name: "SENA - PR√äMIO M√ÅXIMO", level: "max" },
                    5: { name: "Quina", level: "high" },
                    4: { name: "Quadra", level: "mid" }
                }
            },
            lotofacil: {
                name: "Lotof√°cil", min: 15, max: 20, range: 25, start: 1, color: "#930089",
                prizes: {
                    15: { name: "15 ACERTOS - M√ÅXIMO", level: "max" },
                    14: { name: "14 Acertos", level: "high" },
                    13: { name: "13 Acertos", level: "mid" },
                    12: { name: "12 Acertos", level: "low" },
                    11: { name: "11 Acertos", level: "low" }
                }
            },
            quina: {
                name: "Quina", min: 5, max: 15, range: 80, start: 1, color: "#260085",
                prizes: {
                    5: { name: "QUINA - M√ÅXIMO", level: "max" },
                    4: { name: "Quadra", level: "high" },
                    3: { name: "Terno", level: "mid" },
                    2: { name: "Duque", level: "low" }
                }
            },
            lotomania: {
                name: "Lotomania", min: 50, max: 50, range: 100, start: 0, color: "#f78100", label00: true,
                prizes: {
                    20: { name: "20 ACERTOS - M√ÅXIMO", level: "max" },
                    19: { name: "19 Acertos", level: "high" },
                    18: { name: "18 Acertos", level: "mid" },
                    17: { name: "17 Acertos", level: "mid" },
                    16: { name: "16 Acertos", level: "low" },
                    15: { name: "15 Acertos", level: "low" },
                    0: { name: "0 ACERTOS - ESPELHO", level: "max" } // Espelho rule
                }
            },
            timemania: {
                name: "Timemania", min: 10, max: 10, range: 80, start: 1, color: "#00ff48",
                prizes: {
                    7: { name: "7 ACERTOS - M√ÅXIMO", level: "max" },
                    6: { name: "6 Acertos", level: "high" },
                    5: { name: "5 Acertos", level: "mid" },
                    4: { name: "4 Acertos", level: "low" },
                    3: { name: "3 Acertos", level: "low" }
                }
            },
            diadesorte: {
                name: "Dia de Sorte", min: 7, max: 15, range: 31, start: 1, color: "#cb852b",
                prizes: {
                    7: { name: "7 ACERTOS - M√ÅXIMO", level: "max" },
                    6: { name: "6 Acertos", level: "high" },
                    5: { name: "5 Acertos", level: "mid" },
                    4: { name: "4 Acertos", level: "low" }
                }
            }
        };

        // --- 2. STATE ---
        let state = {
            tickets: [],
            drawnNumbers: [],
            currentSelection: new Set()
        };

        // --- 3. INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            updateFormRules();
            renderTickets();
            renderDrawnNumbers();

            // Allow enter key in draw input
            document.getElementById('drawInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') addDrawnNumber();
            });
        });

        // --- 4. CORE LOGIC ---

        function updateFormRules() {
            const gameKey = document.getElementById('gameType').value;
            const rules = GAMES[gameKey];

            // Update Quantity Select
            const qtySelect = document.getElementById('numberQuantity');
            qtySelect.innerHTML = '';
            for (let i = rules.min; i <= rules.max; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i + (i === rules.min ? " (M√≠nimo)" : "");
                qtySelect.appendChild(opt);
            }

            // Clear current selection
            state.currentSelection.clear();
            renderGrid();
        }

        function renderGrid() {
            const gameKey = document.getElementById('gameType').value;
            const rules = GAMES[gameKey];
            const maxSelection = parseInt(document.getElementById('numberQuantity').value);
            const gridContainer = document.getElementById('gridSelection');

            gridContainer.innerHTML = '';
            document.getElementById('selectionCount').textContent = `${state.currentSelection.size} / ${maxSelection}`;

            const start = rules.start;
            const end = rules.start === 0 ? 99 : rules.range; // For Lotomania (0-99) or regular (1-range)

            for (let i = start; i <= end; i++) {
                const btn = document.createElement('div');
                let numStr = i.toString().padStart(2, '0');
                if (rules.label00 && i === 0) numStr = "00"; // Lotomania legacy style often uses 00, but logic considers value 0

                btn.className = `grid-num ${state.currentSelection.has(i) ? 'selected' : ''}`;
                btn.textContent = numStr;
                btn.onclick = () => toggleNumberSelection(i, maxSelection);
                gridContainer.appendChild(btn);
            }
        }

        function toggleNumberSelection(num, max) {
            if (state.currentSelection.has(num)) {
                state.currentSelection.delete(num);
            } else {
                if (state.currentSelection.size >= max) {
                    showToast(`M√°ximo de ${max} n√∫meros atingido!`, 'error');
                    return;
                }
                state.currentSelection.add(num);
            }
            renderGrid();
        }

        function addTicket() {
            const gameKey = document.getElementById('gameType').value;
            const requiredQty = parseInt(document.getElementById('numberQuantity').value);
            const name = document.getElementById('ticketName').value.trim() || `Jogo de ${GAMES[gameKey].name}`;

            if (state.currentSelection.size !== requiredQty) {
                showToast(`Selecione exatamente ${requiredQty} dezenas!`, 'error');
                return;
            }

            const newTicket = {
                id: Date.now(),
                game: gameKey,
                name: name,
                numbers: Array.from(state.currentSelection).sort((a, b) => a - b),
                matches: 0
            };

            state.tickets.push(newTicket);
            saveState();

            // Reset selection but keep game config
            state.currentSelection.clear();
            document.getElementById('ticketName').value = '';
            renderGrid();
            renderTickets();
            showToast("Bilhete salvo com sucesso!");
        }

        // MODAL LOGIC
        let pendingAction = null;

        function showConfirm(title, message, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('open');
            pendingAction = action;

            document.getElementById('btnConfirm').onclick = () => {
                if (pendingAction) pendingAction();
                closeModal();
            };
            document.getElementById('btnCancel').onclick = closeModal;
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('open');
            pendingAction = null;
        }

        function deleteTicket(id) {
            showConfirm("Excluir Bilhete", "Deseja realmente remover este bilhete?", () => {
                state.tickets = state.tickets.filter(t => t.id !== id);
                saveState();
                renderTickets();
                showToast("Bilhete removido.");
            });
        }

        // --- 5. DRAW & CHECKING LOGIC ---

        function addDrawnNumber() {
            const input = document.getElementById('drawInput');
            const val = parseInt(input.value);

            if (isNaN(val)) return;

            // Simple validation check, though different games have different ranges,
            // the draw is global conceptually in this UI or user clears for next game.
            // Let's just allow it but check duplicate.
            if (state.drawnNumbers.includes(val)) {
                showToast(`N√∫mero ${val} j√° sorteado!`, 'error');
                input.value = '';
                return;
            }

            state.drawnNumbers.push(val);
            input.value = '';

            saveState();
            renderDrawnNumbers();
            recalcAndSort();
        }

        function resetDraw() {
            showConfirm("Reiniciar Sorteio", "Os n√∫meros sorteados ser√£o limpos, mas os bilhetes continuar√£o salvos.", () => {
                state.drawnNumbers = [];
                saveState();
                renderDrawnNumbers();
                recalcAndSort();
                showToast("Sorteio reiniciado.");
            });
        }

        function recalcAndSort() {
            let maxWinTriggered = false;

            // Recalculate matches and prizes
            state.tickets.forEach(ticket => {
                const rules = GAMES[ticket.game];
                const hits = ticket.numbers.filter(n => state.drawnNumbers.includes(n)).length;
                ticket.matches = hits;

                // Determine Prize
                ticket.prize = null;
                if (rules.prizes && rules.prizes[hits]) {
                    ticket.prize = rules.prizes[hits];
                    if (ticket.prize.level === 'max') maxWinTriggered = true;
                }
            });

            // Sort logic: 
            // 1. Prize Level Priority (max > high > mid > low > null)
            // 2. Match count
            // 3. ID (Newest first)

            const levelWeight = { max: 4, high: 3, mid: 2, low: 1 };

            state.tickets.sort((a, b) => {
                const levelA = a.prize ? (levelWeight[a.prize.level] || 0) : 0;
                const levelB = b.prize ? (levelWeight[b.prize.level] || 0) : 0;

                if (levelB !== levelA) return levelB - levelA;
                if (b.matches !== a.matches) return b.matches - a.matches;
                return b.id - a.id;
            });

            renderTickets();

            if (maxWinTriggered) {
                triggerConfetti();
            }
        }

        function triggerConfetti() {
            // Simple confetti burst
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#ffd700', '#00e676', '#ffffff'] // Gold, Green, White
            });
        }

        // --- 6. RENDERING ---

        function renderTickets() {
            const container = document.getElementById('ticketsContainer');
            const countSpan = document.getElementById('totalTickets');
            const filter = document.getElementById('filterType').value;

            container.innerHTML = '';

            const filteredTickets = filter === 'all'
                ? state.tickets
                : state.tickets.filter(t => t.game === filter);

            countSpan.textContent = filteredTickets.length;

            if (filteredTickets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #555; margin-top: 50px;">Nenhum bilhete encontrado.</p>';
                return;
            }

            filteredTickets.forEach((ticket, index) => {
                const gameCfg = GAMES[ticket.game];

                const card = document.createElement('div');
                card.className = 'ticket-card';
                // Apply Winner Class
                if (ticket.prize) {
                    card.classList.add(`win-${ticket.prize.level}`);
                } else {
                    card.style.borderColor = gameCfg.color;
                }

                // Header
                const header = document.createElement('div');
                header.className = 'ticket-header';

                // Construct Badge if won
                let badgeHtml = '';
                if (ticket.prize) {
                    badgeHtml = `<span class="badge badge-${ticket.prize.level}">${ticket.prize.name}</span>`;
                }

                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `<div class="ticket-title">
                                        ${ticket.name} 
                                        <span class="match-count ${ticket.matches > 0 ? 'winner' : ''}">${ticket.matches} Acertos</span>
                                        ${badgeHtml}
                                     </div>
                                     <div class="ticket-game-type" style="color:${gameCfg.color}">${gameCfg.name}</div>`;

                const btnDel = document.createElement('button');
                btnDel.className = 'btn-danger';
                btnDel.textContent = 'X';
                btnDel.onclick = () => deleteTicket(ticket.id);

                header.appendChild(infoDiv);
                header.appendChild(btnDel);
                card.appendChild(header);

                // Numbers
                const numContainer = document.createElement('div');
                numContainer.className = 'ticket-numbers';

                ticket.numbers.forEach(num => {
                    const el = document.createElement('div');
                    el.className = 'ticket-num';
                    el.textContent = num.toString().padStart(2, '0');
                    if (state.drawnNumbers.includes(num)) {
                        el.classList.add('hit');
                        // Keep specific color if not overall winner style, or force contrast?
                        // Winner styles have dark backgrounds, so neon green fits well.
                        if (!ticket.prize) el.style.backgroundColor = gameCfg.color;
                    }
                    numContainer.appendChild(el);
                });
                card.appendChild(numContainer);

                // Reorder Animation
                card.style.animation = `popIn 0.3s ease forwards`;
                // Stagger delay slightly for list effect
                card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;

                container.appendChild(card);
            });
        }

        function renderDrawnNumbers() {
            const container = document.getElementById('drawnNumbersList');
            container.innerHTML = '';
            state.drawnNumbers.forEach(n => {
                const el = document.createElement('div');
                el.className = 'drawn-num';
                el.textContent = n.toString().padStart(2, '0');
                container.appendChild(el);
            });
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // --- 7. STORAGE ---
        function saveState() {
            localStorage.setItem('loterias_app_data', JSON.stringify({
                tickets: state.tickets,
                drawnNumbers: state.drawnNumbers
            }));
        }

        function loadState() {
            const saved = localStorage.getItem('loterias_app_data');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.tickets = parsed.tickets || [];
                state.drawnNumbers = parsed.drawnNumbers || [];
            }
        }

        function clearAllData() {
            showConfirm("Limpar Tudo", "Isso apagar√° TODOS os bilhetes e dados salvos. N√£o h√° como desfazer.", () => {
                localStorage.removeItem('loterias_app_data');
                state.tickets = [];
                state.drawnNumbers = [];
                state.currentSelection.clear();

                // Clear inputs
                document.getElementById('ticketName').value = '';
                document.getElementById('drawInput').value = '';

                renderTickets();
                renderDrawnNumbers();
                renderGrid();
                showToast("Sistema resetado com sucesso.");
            });
        }

        // --- 8. PDF IMPORT (REFINED) ---
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showToast('Por favor, selecione um arquivo PDF.', 'error');
                return;
            }

            const statusParams = document.getElementById('pdfStatus');
            statusParams.textContent = "Lendo arquivo...";

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullTextLines = [];

                statusParams.textContent = `Processando ${pdf.numPages} p√°ginas...`;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();

                    let lastY;
                    let pageLines = [];
                    let currentLine = "";

                    // Sort items by Y descending (top to bottom)
                    textContent.items.sort((a, b) => {
                        if (Math.abs(a.transform[5] - b.transform[5]) > 4) {
                            return b.transform[5] - a.transform[5];
                        }
                        return a.transform[4] - b.transform[4];
                    });

                    textContent.items.forEach(item => {
                        if (lastY !== undefined && Math.abs(item.transform[5] - lastY) > 5) {
                            pageLines.push(currentLine);
                            currentLine = "";
                        }
                        currentLine += " " + item.str;
                        lastY = item.transform[5];
                    });
                    if (currentLine) pageLines.push(currentLine);

                    fullTextLines = fullTextLines.concat(pageLines);
                }

                statusParams.textContent = "Analisando dados...";
                processPdfLines(fullTextLines);
                statusParams.textContent = "";
                event.target.value = "";

            } catch (err) {
                console.error(err);
                showToast("Erro ao ler PDF.", "error");
                statusParams.textContent = "Erro.";
            }
        }

        function processPdfLines(lines) {
            // 1. Detect Game Type
            const headerText = lines.slice(0, 20).join(" ").toUpperCase();
            let detectedGame = null;

            const keyMap = {
                "MEGA-SENA": "megasena", "MEGA DA VIRADA": "megasena",
                "LOTOF√ÅCIL": "lotofacil", "LOTOFACIL": "lotofacil",
                "QUINA": "quina",
                "LOTOMANIA": "lotomania",
                "TIMEMANIA": "timemania",
                "DIA DE SORTE": "diadesorte"
            };

            for (const [key, value] of Object.entries(keyMap)) {
                if (headerText.includes(key)) {
                    detectedGame = value;
                    break;
                }
            }

            const selectEl = document.getElementById('gameType');
            if (detectedGame && selectEl.value !== detectedGame) {
                if (confirm(`Detectamos "${GAMES[detectedGame].name}" no PDF. Deseja mudar para essa modalidade?`)) {
                    selectEl.value = detectedGame;
                    updateFormRules();
                }
            }

            const gameKey = selectEl.value;
            const rules = GAMES[gameKey];

            let importCount = 0;

            // 2. Process Lines
            lines.forEach(line => {
                const rawNumbers = line.match(/\b\d{1,2}\b/g);
                if (!rawNumbers) return;

                let numbers = rawNumbers.map(n => parseInt(n));

                const validNumbers = numbers.filter(n => {
                    if (gameKey === 'lotomania' && n === 0) return true;
                    return n >= rules.start && n <= rules.range;
                });

                const unique = [...new Set(validNumbers)];

                // Allow strict variable quantity: must be at least min game size
                if (unique.length < rules.min || unique.length > 50) return;

                const newTicket = {
                    id: Date.now() + Math.random(),
                    game: gameKey,
                    name: `Importado (PDF)`,
                    numbers: unique.sort((a, b) => a - b),
                    matches: 0
                };

                state.tickets.push(newTicket);
                importCount++;
            });

            if (importCount > 0) {
                saveState();
                renderTickets();
                showToast(`${importCount} bilhetes importados!`);
            } else {
                showToast("Nenhum bilhete encontrado. Verifique se o arquivo √© v√°lido.", "error");
            }
        }
    </script>

    <!-- Advanced Import Modal -->
    <div id="importModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <h3>Importa√ß√£o Avan√ßada</h3>
            <p style="font-size: 0.9em; color: var(--text-secondary);">
                Cole os dados do PDF ou envie um arquivo CSV/TXT.
                <br><em>Formato: "ID", "COTA", "N√öMEROS..."</em>
            </p>

            <textarea id="importText" rows="10" placeholder="Cole aqui os dados..."
                style="width: 100%; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 6px; padding: 10px; font-family: monospace;"></textarea>

            <div style="margin-top: 10px; text-align: left;">
                <label style="font-size: 0.9em;">Ou carregue arquivo:</label>
                <input type="file" id="advancedFile" accept=".csv, .txt" onchange="loadAdvancedFile(event)"
                    style="font-size: 0.9em;">
            </div>

            <div id="importPreview"
                style="margin-top: 15px; font-size: 0.9em; color: var(--accent); white-space: pre-wrap; display: none;">
            </div>

            <div class="modal-actions">
                <button class="btn-primary" onclick="processAdvancedImport()">Processar e Salvar</button>
                <button class="btn-danger" style="background-color: #555;"
                    onclick="closeImportModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 9. ADVANCED IMPORT LOGIC ---

        function openImportModal() {
            document.getElementById('importModal').classList.add('open');
            document.getElementById('importText').value = '';
            document.getElementById('importPreview').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('open');
        }

        function loadAdvancedFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('importText').value = e.target.result;
                generatePreview();
            };
            reader.readAsText(file);
        }

        // Real-time preview generator
        document.getElementById('importText').addEventListener('keyup', generatePreview);

        function generatePreview() {
            const text = document.getElementById('importText').value;
            if (!text.trim()) return;

            const results = parseLegacyFormat(text, true); // dry run
            const previewEl = document.getElementById('importPreview');

            if (results.count > 0) {
                previewEl.textContent = `‚úÖ Reconhecidos ${results.groups} Bilhetes contendo um total de ${results.count} jogos v√°lidos.`;
                previewEl.style.color = 'var(--accent)';
                previewEl.style.display = 'block';
            } else {
                previewEl.textContent = `‚ö†Ô∏è Nenhum jogo v√°lido identificado. Verifique o formato.`;
                previewEl.style.color = 'var(--virada)';
                previewEl.style.display = 'block';
            }
        }

        function processAdvancedImport() {
            const text = document.getElementById('importText').value;
            if (!text.trim()) {
                showToast("Cole os dados ou carregue um arquivo.", "error");
                return;
            }

            const results = parseLegacyFormat(text, false); // committed run

            if (results.count > 0) {
                saveState();
                renderTickets();
                showToast(`${results.count} jogos importados com sucesso!`);
                closeImportModal();
            } else {
                showToast("Falha na importa√ß√£o. Verifique o formato dos dados.", "error");
            }
        }

        function parseLegacyFormat(text, dryRun) {
            const gameKey = document.getElementById('gameType').value;
            const rules = GAMES[gameKey];

            const lines = text.split(/\r?\n/);
            let currentTicketName = "Importado";
            let addedCount = 0;
            let groupCount = new Set();

            lines.forEach(line => {
                // Determine delimiter
                if (!line.trim()) return;

                // Remove quotes globally
                const cleanLine = line.replace(/"/g, '');
                const cols = cleanLine.split(/,|;|\t/);

                // Logic: Col 0 = ID. If present, update group name.
                if (cols[0] && cols[0].trim()) {
                    currentTicketName = `Bilhete ${cols[0].trim()}`;
                    groupCount.add(currentTicketName);
                }

                // Numbers start at Col 2 (0=ID, 1=Cota, 2=First Num)
                const potentialNumbers = cols.slice(2);

                const nums = [];
                potentialNumbers.forEach(val => {
                    const cleanVal = val.replace(/[^\d]/g, '');
                    if (cleanVal) {
                        const n = parseInt(cleanVal, 10);
                        if (!isNaN(n)) nums.push(n);
                    }
                });

                // Validate Numbers
                const validNums = nums.filter(n => {
                    if (gameKey === 'lotomania' && n === 0) return true;
                    return n >= rules.start && n <= rules.range;
                });

                const unique = [...new Set(validNums)];

                // Check min constraints
                if (unique.length >= rules.min) {
                    if (!dryRun) {
                        state.tickets.push({
                            id: Date.now() + Math.random(),
                            game: gameKey,
                            name: currentTicketName,
                            numbers: unique.sort((a, b) => a - b),
                            matches: 0
                        });
                    }
                    addedCount++;
                }
            });

            return { count: addedCount, groups: groupCount.size };
        }
    </script>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>

</html>